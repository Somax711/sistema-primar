@model RendicionesPrimar.Models.ViewModels.RendicionDetalleViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = $"Rendición #{Model.NumeroTicket} - Revisión Supervisor";
    
    string claseEstado = Model.Estado switch {
        "aprobado" or "aprobado_1" or "aprobado_2" => "aprobado",
        "rechazado" or "rechazado_1" => "rechazado",
        "pendiente" => "pendiente",
        "pagado" => "pagado",
        _ => "pendiente"
    };
    string textoEstado = Model.Estado.ToUpperInvariant().Replace("_", " ");
}

<style>
    /* ... otros estilos ... */
    .modal-rechazo-bg {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(30,41,59,0.35);
        backdrop-filter: blur(4px) brightness(0.9);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
    }
    .modal-rechazo-panel {
        background: #fff;
        padding: 36px 32px 28px 32px;
        border-radius: 18px;
        max-width: 410px;
        width: 95%;
        box-shadow: 0 8px 32px rgba(239,68,68,0.18);
        position: relative;
        animation: fadeInDown 0.5s cubic-bezier(0.4,0,0.2,1);
        display: flex;
        flex-direction: column;
        gap: 18px;
    }
    .modal-rechazo-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #ef4444;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    .modal-rechazo-title i {
        color: #ef4444;
        font-size: 1.5rem;
    }
    .modal-rechazo-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        margin-left: auto;
        transition: color 0.2s;
        position: absolute;
        right: 18px;
        top: 18px;
    }
    .modal-rechazo-close:hover {
        color: #ef4444;
    }
    .modal-rechazo-body {
        margin-bottom: 10px;
        color: #991b1b;
        font-size: 1.08rem;
        font-weight: 500;
        text-align: center;
    }
    .modal-rechazo-body textarea {
        width: 100%;
        border-radius: 8px;
        border: 1.5px solid #e5e7eb;
        padding: 10px 12px;
        font-size: 1rem;
        margin-top: 10px;
        margin-bottom: 0;
        resize: vertical;
        min-height: 70px;
        transition: border 0.2s;
    }
    .modal-rechazo-body textarea:focus {
        border: 1.5px solid #ef4444;
        outline: none;
    }
    .modal-rechazo-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
    }
    .btn-cancelar {
        background: #6b7280;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
    }
    .btn-confirmar {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
    }
    .btn-cancelar:hover {
        background: #4b5563;
    }
    .btn-confirmar:hover {
        background: #dc2626;
    }
    @@keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="main-super-container" style="max-width: 1200px; margin: 0 auto; padding: 0 12px;">
    <!-- Tarjeta principal de la rendición -->
    <div class="card-super fade-in-up" style="background: var(--primar-white); border-radius: 18px; box-shadow: 0 4px 24px 0 rgba(31,90,136,0.10); padding: 36px 36px 24px 36px; margin-bottom: 40px; border: none; display: flex; justify-content: space-between; align-items: flex-start; gap: 32px; flex-wrap: wrap;">
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <h1 style="font-size: 2.3rem; font-weight: 800; color: var(--primar-text); margin: 0; letter-spacing: 0.01em; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-file-invoice-dollar" style="font-size: 1.5rem; color: var(--primar-primary);"></i>
                Rendición #@Model.NumeroTicket
            </h1>
            <p style="color: var(--primar-text-light); margin: 0; font-size: 1.18rem; font-weight: 500;">@Model.Titulo</p>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                <span style="background: #2563eb; color: white; font-size: 0.8rem; font-weight: 700; border-radius: 12px; padding: 2px 10px; text-transform: uppercase; letter-spacing: 0.04em;">SUPERVISOR</span>
                <span style="color: var(--primar-text-light); font-size: 0.9rem;">• Revisión de Primera Instancia</span>
            </div>
        </div>
        <div style="text-align: right; min-width: 220px;">
            <div class="status-badge status-@claseEstado" style="font-size: 1.1rem; padding: 10px 22px; margin-bottom: 8px; display: inline-flex; align-items: center; gap: 10px;">
                <i class="fas fa-circle"></i>
                @textoEstado
            </div>
            <div style="color: var(--primar-text-light); font-size: 1.01rem; font-weight: 600;">Creada el @Model.FechaCreacion.ToString("dd/MM/yyyy 'a las' HH:mm")</div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px; align-items: flex-start;">
        <!-- Columna Principal -->
        <div style="display: flex; flex-direction: column; gap: 32px;">
            <!-- Información de la Rendición -->
            <div class="card-super" style="background: var(--primar-white); border-radius: 16px; box-shadow: 0 2px 12px 0 rgba(31,90,136,0.08); padding: 28px 28px 18px 28px; border: none;">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--primar-text); margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="font-size: 1.1rem; color: var(--primar-primary);"></i>
                    Información de la Rendición
                </h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 18px;">
                    <div>
                        <label class="label-super">TÍTULO</label>
                        <p class="value-super">@Model.Titulo</p>
                    </div>
                    <div>
                        <label class="label-super">MONTO TOTAL</label>
                        <p class="value-super" style="color: var(--primar-success); font-size: 1.3rem; font-weight: 700;">$@Model.MontoTotal.ToString("N0")</p>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label class="label-super">DESCRIPCIÓN</label>
                        <p class="value-super" style="background: var(--primar-secondary); padding: 12px; border-radius: var(--primar-radius-sm);">@Model.Descripcion</p>
                    </div>
                </div>
            </div>
            
            <!-- Información del Empleado -->
            <div class="card-super" style="background: var(--primar-white); border-radius: 16px; box-shadow: 0 2px 12px 0 rgba(31,90,136,0.08); padding: 28px 28px 18px 28px; border: none;">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--primar-text); margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-user" style="font-size: 1.1rem; color: var(--primar-primary);"></i>
                    Información del Empleado
                </h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 18px;">
                    <div>
                        <label class="label-super">NOMBRE COMPLETO</label>
                        <p class="value-super">@(string.IsNullOrEmpty(Model.Apellidos) ? "No especificado" : Model.Nombre + " " + Model.Apellidos)</p>
                    </div>
                    <div>
                        <label class="label-super">RUT</label>
                        <p class="value-super">@(string.IsNullOrEmpty(Model.Rut) ? "No especificado" : Model.Rut)</p>
                    </div>
                    <div>
                        <label class="label-super">EMAIL</label>
                        <p class="value-super">@Model.Usuario.Email</p>
                    </div>
                    <div>
                        <label class="label-super">TELÉFONO</label>
                        <p class="value-super">@(string.IsNullOrEmpty(Model.Telefono) ? "No especificado" : Model.Telefono)</p>
                    </div>
                    <div>
                        <label class="label-super">CARGO</label>
                        <p class="value-super">@(string.IsNullOrEmpty(Model.Cargo) ? "No especificado" : Model.Cargo)</p>
                    </div>
                    <div>
                        <label class="label-super">DEPARTAMENTO</label>
                        <p class="value-super">@(string.IsNullOrEmpty(Model.Departamento) ? "No especificado" : Model.Departamento)</p>
                    </div>
                </div>
            </div>
            
            <!-- Archivos Adjuntos -->
            @if (Model.ArchivosAdjuntos.Any())
            {
                <div class="card-super" style="background: var(--primar-white); border-radius: 16px; box-shadow: 0 2px 12px 0 rgba(31,90,136,0.08); padding: 28px 28px 18px 28px; border: none;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--primar-text); margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-paperclip" style="font-size: 1.1rem; color: var(--primar-primary);"></i>
                        Documentos Adjuntos
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;">
                        @foreach (var archivo in Model.ArchivosAdjuntos)
                        {
                            <div style="background: var(--primar-secondary); border-radius: var(--primar-radius-sm); padding: 12px; border: none; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-file" style="color: var(--primar-primary); font-size: 1.1rem;"></i>
                                <div style="flex: 1;">
                                    <p style="font-weight: 500; color: var(--primar-text); margin: 0; font-size: 0.95rem;">@archivo.NombreArchivo</p>
                                    <p style="color: var(--primar-text-light); margin: 2px 0 0 0; font-size: 0.8rem;">@archivo.TipoArchivo • @((archivo.TamanoArchivo / 1024.0 / 1024.0).ToString("F2")) MB</p>
                                </div>
                                <a href="@Url.Action("DescargarArchivo", "Rendiciones", new { id = archivo.Id })" 
                                   style="color: var(--primar-primary); text-decoration: none; padding: 6px; border-radius: 50%; transition: var(--primar-transition);" 
                                   onmouseover="this.style.background='rgba(37, 99, 235, 0.1)'" 
                                   onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
        
        <!-- Sidebar -->
        <div style="display: flex; flex-direction: column; gap: 32px;">
            <!-- Estado y Acciones PARA SUPERVISOR -->
            <div class="card-super" style="background: var(--primar-white); border-radius: 16px; box-shadow: 0 2px 12px 0 rgba(31,90,136,0.08); padding: 28px 28px 18px 28px; border: none;">
                <h2 style="font-size: 1.1rem; font-weight: 700; color: var(--primar-text); margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-cogs" style="font-size: 1rem; color: var(--primar-primary);"></i>
                    Estado y Acciones
                </h2>
                <div style="margin-bottom: 18px;">
                    <div class="status-badge status-@claseEstado" style="width: 100%; justify-content: center; font-size: 1.1rem; padding: 12px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-circle"></i>
                        @textoEstado
                    </div>
                </div>
                @if (Model.Estado == "pendiente")
                {
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <form asp-action="AprobarRendicion" asp-controller="Supervisores" asp-route-id="@Model.Id" method="post" style="width: 100%;">
                            <button type="submit" class="btn-action btn-primary" style="width: 100%; justify-content: center;">
                                <i class="fas fa-check"></i>
                                Aprobar Rendición
                            </button>
                        </form>
                        <button type="button" class="btn-action btn-danger" style="width: 100%; justify-content: center;" onclick="abrirModalRechazo()">
                            <i class="fas fa-times"></i>
                            Rechazar Rendición
                        </button>
                    </div>
                    <div id="modalRechazo" class="modal-rechazo-bg">
                        <div class="modal-rechazo-panel">
                            <div class="modal-rechazo-title">
                                <i class="fas fa-exclamation-triangle"></i> Motivo del rechazo
                                <span class="modal-rechazo-close" onclick="cerrarModalRechazo()">&times;</span>
                            </div>
                            <form id="formRechazo" asp-action="RechazarRendicion" asp-controller="Supervisores" asp-route-id="@Model.Id" method="post">
                                <div class="modal-rechazo-body">
                                    <label for="comentarios">Por favor, ingrese el motivo del rechazo:</label>
                                    <textarea name="comentarios" id="comentarios" rows="4" placeholder="Ingrese el motivo del rechazo" required></textarea>
                                </div>
                                <div class="modal-rechazo-footer">
                                    <button type="button" onclick="cerrarModalRechazo()" class="btn-cancelar">Cancelar</button>
                                    <button type="submit" class="btn-confirmar">Rechazar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                else if (Model.Estado == "aprobado_2")
                {
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <form asp-action="ProcesarPago" asp-controller="Supervisores" asp-route-id="@Model.Id" method="post" style="width: 100%;">
                            <button type="submit" class="btn-action btn-success" style="width: 100%; justify-content: center;">
                                <i class="fas fa-credit-card"></i>
                                Procesar Pago
                            </button>
                        </form>
                    </div>
                }
                else
                {
                    <div style="text-align: center; color: var(--primar-text-light); font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        Esta rendición ya ha sido procesada
                    </div>
                }
            </div>
            
            <!-- Seguimiento del Proceso -->
            <div class="card-super" style="background: var(--primar-white); border-radius: 16px; box-shadow: 0 2px 12px 0 rgba(31,90,136,0.08); padding: 28px 28px 18px 28px; border: none;">
                <h2 style="font-size: 1.1rem; font-weight: 700; color: var(--primar-text); margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-clock" style="font-size: 1rem; color: var(--primar-primary);"></i>
                    Seguimiento del Proceso
                </h2>
                <div style="display: flex; flex-direction: column; gap: 18px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-flag-checkered" style="color: var(--primar-primary); font-size: 1rem;"></i>
                        <div style="flex: 1;">
                            <p style="font-weight: 600; color: var(--primar-text); margin: 0; font-size: 1rem;">Primera Revisión</p>
                            <p style="color: var(--primar-text-light); margin: 2px 0 0 0; font-size: 0.9rem;">
                                @if (Model.Estado == "pendiente")
                                {
                                    <span style="color: var(--primar-warning);">En revisión</span>
                                }
                                else if (Model.Estado == "rechazado" || Model.Estado == "rechazado_1")
                                {
                                    <span style="color: var(--primar-danger);">Rechazado</span>
                                }
                                else
                                {
                                    <span style="color: var(--primar-success);">Aprobado</span>
                                }
                            </p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-user-check" style="color: var(--primar-primary); font-size: 1rem;"></i>
                        <div style="flex: 1;">
                            <p style="font-weight: 600; color: var(--primar-text); margin: 0; font-size: 1rem;">Aprobación Final</p>
                            <p style="color: var(--primar-text-light); margin: 2px 0 0 0; font-size: 0.9rem;">
                                @if (Model.Estado == "pendiente")
                                {
                                    <span style="color: var(--primar-text-light);">En espera</span>
                                }
                                else if (Model.Estado == "aprobado_1")
                                {
                                    <span style="color: var(--primar-warning);">En revisión</span>
                                }
                                else if (Model.Estado == "rechazado")
                                {
                                    <span style="color: var(--primar-danger);">Rechazado</span>
                                }
                                else if (Model.Estado == "aprobado_2" || Model.Estado == "pagado")
                                {
                                    <span style="color: var(--primar-success);">Aprobado</span>
                                }
                            </p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-credit-card" style="color: var(--primar-primary); font-size: 1rem;"></i>
                        <div style="flex: 1;">
                            <p style="font-weight: 600; color: var(--primar-text); margin: 0; font-size: 1rem;">Procesamiento de Pago</p>
                            <p style="color: var(--primar-text-light); margin: 2px 0 0 0; font-size: 0.9rem;">
                                @if (Model.Estado == "rechazado")
                                {
                                    <span style="color: var(--primar-danger);">Rechazado</span>
                                }
                                else if (Model.Estado == "pagado")
                                {
                                    <span style="color: var(--primar-success);">Completado</span>
                                }
                                else
                                {
                                    <span style="color: var(--primar-text-light);">En espera</span>
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.MotivoRechazoSupervisor) && (Model.Estado == "rechazado" || Model.Estado == "rechazado_1"))
{
    <div class="card-super" style="background: #fff0f0; border-radius: 16px; box-shadow: 0 2px 12px 0 rgba(239,68,68,0.08); padding: 24px; border: 1px solid #ef4444; margin-bottom: 16px;">
        <h2 style="font-size: 1.1rem; font-weight: 700; color: #991b1b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user-tie" style="color: #ef4444;"></i>
            Motivo de Rechazo del Supervisor
        </h2>
        <div style="color: #991b1b; font-size: 1rem; white-space: pre-line;">@Model.MotivoRechazoSupervisor</div>
    </div>
}
@if (!string.IsNullOrWhiteSpace(Model.MotivoRechazoGerente) && Model.Estado == "rechazado")
{
    <div class="card-super" style="background: #fff0f0; border-radius: 16px; box-shadow: 0 2px 12px 0 rgba(239,68,68,0.08); padding: 24px; border: 1px solid #ef4444; margin-bottom: 24px;">
        <h2 style="font-size: 1.1rem; font-weight: 700; color: #991b1b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user-shield" style="color: #ef4444;"></i>
            Motivo de Rechazo del Gerente
        </h2>
        <div style="color: #991b1b; font-size: 1rem; white-space: pre-line;">@Model.MotivoRechazoGerente</div>
    </div>
}

<script>
    function abrirModalRechazo() {
        document.getElementById('modalRechazo').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function cerrarModalRechazo() {
        document.getElementById('modalRechazo').style.display = 'none';
        document.body.style.overflow = '';
    }
    document.getElementById('formRechazo').onsubmit = function() {
        var txt = this.comentarios.value.trim();
        if (!txt) {
            alert('Por favor, ingrese el motivo del rechazo.');
            return false;
        }
    };
    window.onclick = function(event) {
        var modal = document.getElementById('modalRechazo');
        if (event.target == modal) {
            // No cerrar el modal al hacer clic fuera, solo con botón cancelar o cerrar
        }
    }
</script> 
<div style="text-align:center;color:#64748b;font-size:0.98rem;margin:32px 0 12px 0;opacity:0.85;">
    Todos los derechos reservados - Catalina Núñez
</div> 